<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SupremeAmer Coin Mining Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@8.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: #e9ecef;
            transform: scale(1.02);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .mining-section {
            text-align: center;
        }

        .mining-button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.5em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin: 20px 0;
        }

        .mining-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .mining-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .mining-animation {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }

        .mining-circle {
            width: 100%;
            height: 100%;
            border: 5px solid var(--primary);
            border-radius: 50%;
            position: relative;
            animation: rotate 2s linear infinite;
        }

        .mining-circle::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .transaction-history {
            margin-top: 30px;
        }

        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }

        .transaction-item:hover {
            background: #f8f9fa;
        }

        .transaction-amount {
            font-weight: bold;
            color: var(--success);
        }

        .withdraw-section {
            margin-top: 20px;
        }

        .withdraw-button {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .withdraw-button:hover {
            background: #218838;
        }

        .withdraw-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger);
        }

        .login-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .login-section h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .login-button {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .login-button:hover {
            background: #5a6fd8;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* New Features Styles */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .upgrade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .upgrade-item:hover {
            border-color: var(--primary);
            background: #f8f9ff;
        }

        .upgrade-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .upgrade-button:hover:not(:disabled) {
            background: #5a6fd8;
        }

        .upgrade-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .leaderboard {
            max-height: 400px;
            overflow-y: auto;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }

        .leaderboard-item:hover {
            background: #f8f9fa;
        }

        .leaderboard-rank {
            font-weight: bold;
            color: var(--primary);
            width: 30px;
        }

        .leaderboard-name {
            flex: 1;
            margin: 0 15px;
        }

        .leaderboard-score {
            font-weight: bold;
            color: var(--success);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .achievement-item.unlocked {
            border-color: var(--success);
            background: #f8fff9;
        }

        .achievement-icon {
            font-size: 2em;
            margin-right: 15px;
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin-top: 5px;
            overflow: hidden;
        }

        .achievement-progress-bar {
            background: var(--success);
            height: 100%;
            transition: width 0.3s ease;
        }

        .referral-section {
            text-align: center;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            margin-top: 20px;
        }

        .referral-code {
            background: white;
            border: 2px dashed var(--primary);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.2em;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .referral-code:hover {
            background: #f0f2ff;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .quest-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .quest-item.completed {
            border-color: var(--success);
            background: #f8fff9;
        }

        .quest-reward {
            color: var(--success);
            font-weight: bold;
        }

        .admin-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-stat {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>‚ö° SupremeAmer Miner</h2>
            <div class="tab-container">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('login')">Login</button>
                    <button class="tab" onclick="showTab('register')">Register</button>
                </div>
                
                <div id="login" class="tab-content active">
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <div class="form-group">
                        <label>Referral Code (optional):</label>
                        <input type="text" id="loginReferralCode" placeholder="Enter referral code">
                    </div>
                    <button class="login-button" onclick="login()">Start Mining</button>
                </div>
                
                <div id="register" class="tab-content">
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="registerUsername" placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="registerEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="registerPassword" placeholder="Choose a password">
                    </div>
                    <div class="form-group">
                        <label>Referral Code (optional):</label>
                        <input type="text" id="registerReferralCode" placeholder="Enter referral code">
                    </div>
                    <button class="login-button" onclick="register()">Create Account</button>
                </div>
            </div>
        </div>

        <!-- Main Mining Interface (Initially Hidden) -->
        <div id="miningInterface" class="hidden">
            <div class="header">
                <h1>‚ö° SupremeAmer Coin Miner</h1>
                <p>Mine SupremeAmer coins and withdraw to your BNB wallet</p>
                <div>
                    <button onclick="showTab('main')" class="tab active">Dashboard</button>
                    <button onclick="showTab('upgrades')" class="tab">Upgrades</button>
                    <button onclick="showTab('leaderboard')" class="tab">Leaderboard</button>
                    <button onclick="showTab('achievements')" class="tab">Achievements</button>
                    <button onclick="showTab('referral')" class="tab">Referral</button>
                    <button onclick="showTab('analytics')" class="tab">Analytics</button>
                    <button onclick="logout()" style="background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 10px;">Logout</button>
                </div>
            </div>

            <!-- Main Dashboard Tab -->
            <div id="main" class="tab-content active">
                <div class="dashboard">
                    <div class="card">
                        <h2>üí∞ Mining Stats</h2>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-value" id="coinsMined">0</div>
                                <div class="stat-label">Coins Mined</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="miningPower">1</div>
                                <div class="stat-label">Mining Power</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalEarnings">0</div>
                                <div class="stat-label">Total Earnings (USD)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="miningTime">0</div>
                                <div class="stat-label">Mining Time (mins)</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>‚õèÔ∏è Mining Controller</h2>
                        <div class="mining-section">
                            <div class="mining-animation hidden" id="miningAnimation">
                                <div class="mining-circle"></div>
                            </div>
                            <button class="mining-button" id="miningButton">Start Mining</button>
                            <p id="miningStatus">Ready to start mining SupremeAmer coins</p>
                            
                            <div class="withdraw-section">
                                <button class="withdraw-button" id="withdrawButton" disabled>
                                    Withdraw to BNB Wallet
                                </button>
                                <p style="font-size: 0.9em; margin-top: 10px; color: #666;">
                                    Receiver: 0xYourBnbAddressHere
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="features-grid">
                    <div class="card">
                        <h2>üéØ Daily Quests</h2>
                        <div id="questsList">
                            <!-- Quests will be populated here -->
                        </div>
                    </div>

                    <div class="card">
                        <h2>üèÜ Recent Achievements</h2>
                        <div id="recentAchievements">
                            <!-- Achievements will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>üìä Transaction History</h2>
                    <div class="transaction-list" id="transactionList">
                        <p style="text-align: center; color: #666;">No transactions yet</p>
                    </div>
                </div>
            </div>

            <!-- Upgrades Tab -->
            <div id="upgrades" class="tab-content">
                <div class="card">
                    <h2>üöÄ Mining Upgrades</h2>
                    <div id="upgradesList">
                        <!-- Upgrades will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboard" class="tab-content">
                <div class="card">
                    <h2>üèÜ Global Leaderboard</h2>
                    <div class="leaderboard" id="globalLeaderboard">
                        <!-- Leaderboard will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Achievements Tab -->
            <div id="achievements" class="tab-content">
                <div class="card">
                    <h2>üéñÔ∏è Achievements</h2>
                    <div id="achievementsList">
                        <!-- Achievements will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Referral Tab -->
            <div id="referral" class="tab-content">
                <div class="card">
                    <h2>üë• Referral Program</h2>
                    <div class="referral-section">
                        <h3>Invite Friends & Earn 20% Commission!</h3>
                        <p>Share your referral code and earn 20% of all coins mined by your referrals</p>
                        <div class="referral-code" id="referralCode" onclick="copyReferralCode()">
                            Loading...
                        </div>
                        <p style="font-size: 0.9em; color: #666;">Click to copy referral code</p>
                        
                        <div class="stats" style="margin-top: 20px;">
                            <div class="stat-item">
                                <div class="stat-value" id="referralCount">0</div>
                                <div class="stat-label">Total Referrals</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="referralEarnings">0</div>
                                <div class="stat-label">Referral Earnings</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="card">
                    <h2>üìà Mining Analytics</h2>
                    <div class="chart-container">
                        <canvas id="miningChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Appwrite configuration
        const APPWRITE_ENDPOINT = 'https://fra.cloud.appwrite.io/v1';
        const APPWRITE_PROJECT = '6839d9640019316a160d';
        const APPWRITE_DB_ID = '6839dcca000190bf99f6';
        const APPWRITE_COLLECTION_ID = 'users';
        const SUPREMEAMER_RECEIVER_BNB = '0xYourBnbAddressHere';

        // Initialize Appwrite
        const client = new Appwrite.Client();
        client.setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT);

        const database = new Appwrite.Database(client);
        const account = new Appwrite.Account(client);

        // Mining state
        let miningInterval;
        let isMining = false;
        let coinsMined = 0;
        let miningTime = 0;
        let userId = null;
        let currentUser = null;
        let miningChart = null;

        // Game data
        const upgrades = [
            { id: 'cpu', name: 'Better CPU', description: 'Increase mining speed by 20%', cost: 10, power: 1.2, level: 0, maxLevel: 5 },
            { id: 'gpu', name: 'GPU Mining', description: 'Double your mining power', cost: 25, power: 2, level: 0, maxLevel: 3 },
            { id: 'farm', name: 'Mining Farm', description: '5x mining power boost', cost: 100, power: 5, level: 0, maxLevel: 2 },
            { id: 'asic', name: 'ASIC Miner', description: '10x mining power', cost: 500, power: 10, level: 0, maxLevel: 1 }
        ];

        const achievements = [
            { id: 'first_mining', name: 'First Steps', description: 'Mine your first coin', reward: 5, unlocked: false, progress: 0, target: 1 },
            { id: 'mining_expert', name: 'Mining Expert', description: 'Mine 100 coins', reward: 50, unlocked: false, progress: 0, target: 100 },
            { id: 'mining_master', name: 'Mining Master', description: 'Mine 1000 coins', reward: 200, unlocked: false, progress: 0, target: 1000 },
            { id: 'time_miner', name: 'Time Miner', description: 'Mine for 60 minutes', reward: 25, unlocked: false, progress: 0, target: 60 },
            { id: 'first_withdrawal', name: 'First Withdrawal', description: 'Make your first withdrawal', reward: 10, unlocked: false, progress: 0, target: 1 },
            { id: 'referral_master', name: 'Referral Master', description: 'Refer 5 friends', reward: 100, unlocked: false, progress: 0, target: 5 }
        ];

        const quests = [
            { id: 'daily_mining', name: 'Daily Mining', description: 'Mine for 30 minutes today', reward: 5, progress: 0, target: 30, completed: false },
            { id: 'coin_collector', name: 'Coin Collector', description: 'Collect 50 coins today', reward: 10, progress: 0, target: 50, completed: false },
            { id: 'streak_master', name: 'Streak Master', description: 'Mine for 3 consecutive days', reward: 15, progress: 0, target: 3, completed: false }
        ];

        // DOM elements
        const loginSection = document.getElementById('loginSection');
        const miningInterface = document.getElementById('miningInterface');
        const miningButton = document.getElementById('miningButton');
        const miningAnimation = document.getElementById('miningAnimation');
        const miningStatus = document.getElementById('miningStatus');
        const withdrawButton = document.getElementById('withdrawButton');
        const coinsMinedElement = document.getElementById('coinsMined');
        const miningTimeElement = document.getElementById('miningTime');
        const totalEarningsElement = document.getElementById('totalEarnings');
        const transactionList = document.getElementById('transactionList');
        const notification = document.getElementById('notification');

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Refresh tab content if needed
            if (tabName === 'leaderboard') {
                loadLeaderboard();
            } else if (tabName === 'analytics') {
                initializeChart();
            }
        }

        // Authentication functions
        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const referralCode = document.getElementById('registerReferralCode').value;

            if (!username || !email || !password) {
                showNotification('Please fill all fields', true);
                return;
            }

            try {
                // Create user account
                await account.create('unique()', email, password, username);
                showNotification('Account created successfully! Please login.');
                showTab('login');
                
                // Clear form
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerReferralCode').value = '';
            } catch (error) {
                showNotification('Error creating account: ' + error.message, true);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const referralCode = document.getElementById('loginReferralCode').value;

            if (!email || !password) {
                showNotification('Please enter email and password', true);
                return;
            }

            try {
                // Create session
                await account.createEmailSession(email, password);
                currentUser = await account.get();
                userId = currentUser.$id;
                
                // Initialize user data
                await initializeUser(referralCode);
                
                // Switch to mining interface
                loginSection.classList.add('hidden');
                miningInterface.classList.remove('hidden');
                
                showNotification('Login successful! Welcome to SupremeAmer Miner.');
            } catch (error) {
                showNotification('Login failed: ' + error.message, true);
            }
        }

        async function logout() {
            try {
                await account.deleteSession('current');
                loginSection.classList.remove('hidden');
                miningInterface.classList.add('hidden');
                showNotification('Logged out successfully');
                
                // Clear form
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginReferralCode').value = '';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Initialize user data
        async function initializeUser(referralCode = '') {
            try {
                // Check if user document exists
                try {
                    const userDoc = await database.getDocument(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID, userId);
                    coinsMined = userDoc.coinsMined || 0;
                    miningTime = userDoc.miningTime || 0;
                    
                    // Load upgrades
                    if (userDoc.upgrades) {
                        upgrades.forEach(upgrade => {
                            const savedUpgrade = userDoc.upgrades.find(u => u.id === upgrade.id);
                            if (savedUpgrade) {
                                upgrade.level = savedUpgrade.level;
                            }
                        });
                    }
                    
                    // Load achievements
                    if (userDoc.achievements) {
                        achievements.forEach(achievement => {
                            const savedAchievement = userDoc.achievements.find(a => a.id === achievement.id);
                            if (savedAchievement) {
                                achievement.unlocked = savedAchievement.unlocked;
                                achievement.progress = savedAchievement.progress;
                            }
                        });
                    }
                    
                    // Load quests
                    if (userDoc.quests) {
                        quests.forEach(quest => {
                            const savedQuest = userDoc.quests.find(q => q.id === quest.id);
                            if (savedQuest) {
                                quest.progress = savedQuest.progress;
                                quest.completed = savedQuest.completed;
                            }
                        });
                    }
                    
                } catch (error) {
                    // User document doesn't exist, create it
                    const userData = {
                        coinsMined: 0,
                        miningTime: 0,
                        totalWithdrawn: 0,
                        miningPower: 1,
                        upgrades: upgrades,
                        achievements: achievements,
                        quests: quests,
                        referralCode: generateReferralCode(),
                        referredBy: referralCode,
                        referrals: [],
                        referralEarnings: 0,
                        transactions: [],
                        miningSessions: [],
                        createdAt: new Date().toISOString(),
                        username: currentUser.name,
                        email: currentUser.email,
                        lastLogin: new Date().toISOString()
                    };
                    
                    await database.createDocument(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID, userId, userData);
                    
                    // Handle referral if provided
                    if (referralCode) {
                        await handleReferral(referralCode);
                    }
                }
                
                updateUI();
                loadTransactionHistory();
                renderUpgrades();
                renderAchievements();
                renderQuests();
                loadLeaderboard();
                updateReferralInfo();
            } catch (error) {
                console.error('Error initializing user:', error);
                showNotification('Error initializing mining session', true);
            }
        }

        // Mining functions
        miningButton.addEventListener('click', toggleMining);

        function toggleMining() {
            if (isMining) {
                stopMining();
            } else {
                startMining();
            }
        }

        function startMining() {
            isMining = true;
            miningButton.textContent = 'Stop Mining';
            miningAnimation.classList.remove('hidden');
            miningStatus.textContent = 'Mining SupremeAmer coins...';
            
            miningInterval = setInterval(async () => {
                // Calculate mining power from upgrades
                let totalMiningPower = 1;
                upgrades.forEach(upgrade => {
                    if (upgrade.level > 0) {
                        totalMiningPower *= upgrade.power;
                    }
                });
                
                // Mine coins (random between 0.1 and 0.5 coins per second) multiplied by power
                const baseCoinsPerSecond = (Math.random() * 0.4 + 0.1) / 60;
                const coinsThisSecond = baseCoinsPerSecond * totalMiningPower;
                coinsMined += coinsThisSecond;
                miningTime += 1/60; // Add 1 second in minutes
                
                // Update quest progress
                updateQuestProgress('daily_mining', 1/60);
                updateQuestProgress('coin_collector', coinsThisSecond);
                
                // Update achievement progress
                updateAchievementProgress('first_mining', coinsMined);
                updateAchievementProgress('mining_expert', coinsMined);
                updateAchievementProgress('mining_master', coinsMined);
                updateAchievementProgress('time_miner', miningTime);
                
                // Update every 5 seconds in database to reduce API calls
                if (Math.floor(miningTime * 60) % 5 === 0) {
                    await updateUserData();
                }
                
                updateUI();
            }, 1000);
        }

        function stopMining() {
            isMining = false;
            miningButton.textContent = 'Start Mining';
            miningAnimation.classList.add('hidden');
            miningStatus.textContent = 'Mining stopped. Ready to continue.';
            
            clearInterval(miningInterval);
            updateUserData();
        }

        // Update user data in Appwrite
        async function updateUserData() {
            try {
                await database.updateDocument(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID, userId, {
                    coinsMined: parseFloat(coinsMined.toFixed(6)),
                    miningTime: parseFloat(miningTime.toFixed(2)),
                    lastMiningSession: new Date().toISOString(),
                    upgrades: upgrades,
                    achievements: achievements,
                    quests: quests,
                    miningPower: calculateTotalMiningPower()
                });
            } catch (error) {
                console.error('Error updating user data:', error);
            }
        }

        // Calculate total mining power from upgrades
        function calculateTotalMiningPower() {
            let power = 1;
            upgrades.forEach(upgrade => {
                if (upgrade.level > 0) {
                    power *= upgrade.power;
                }
            });
            return power;
        }

        // Upgrade system
        function renderUpgrades() {
            const upgradesList = document.getElementById('upgradesList');
            upgradesList.innerHTML = '';
            
            upgrades.forEach(upgrade => {
                const upgradeElement = document.createElement('div');
                upgradeElement.className = 'upgrade-item';
                
                const canAfford = coinsMined >= upgrade.cost && upgrade.level < upgrade.maxLevel;
                
                upgradeElement.innerHTML = `
                    <div>
                        <strong>${upgrade.name}</strong>
                        <div style="font-size: 0.9em; color: #666;">${upgrade.description}</div>
                        <div style="font-size: 0.8em; color: #888;">
                            Level: ${upgrade.level}/${upgrade.maxLevel} | Cost: ${upgrade.cost} SAM
                        </div>
                    </div>
                    <button class="upgrade-button" ${!canAfford ? 'disabled' : ''} 
                            onclick="buyUpgrade('${upgrade.id}')">
                        ${upgrade.level >= upgrade.maxLevel ? 'MAX' : 'Buy'}
                    </button>
                `;
                
                upgradesList.appendChild(upgradeElement);
            });
        }

        async function buyUpgrade(upgradeId) {
            const upgrade = upgrades.find(u => u.id === upgradeId);
            
            if (!upgrade || upgrade.level >= upgrade.maxLevel || coinsMined < upgrade.cost) {
                return;
            }
            
            coinsMined -= upgrade.cost;
            upgrade.level++;
            
            // Increase cost for next level
            upgrade.cost = Math.round(upgrade.cost * 1.5);
            
            showNotification(`Upgraded ${upgrade.name} to level ${upgrade.level}!`);
            updateUI();
            renderUpgrades();
            await updateUserData();
        }

        // Achievement system
        function renderAchievements() {
            const achievementsList = document.getElementById('achievementsList');
            const recentAchievements = document.getElementById('recentAchievements');
            
            achievementsList.innerHTML = '';
            recentAchievements.innerHTML = '';
            
            let recentUnlocked = [];
            
            achievements.forEach(achievement => {
                const achievementElement = document.createElement('div');
                achievementElement.className = `achievement-item ${achievement.unlocked ? 'unlocked' : ''}`;
                
                const progressPercent = (achievement.progress / achievement.target) * 100;
                
                achievementElement.innerHTML = `
                    <div class="achievement-icon">${achievement.unlocked ? 'üèÜ' : 'üîí'}</div>
                    <div class="achievement-info">
                        <strong>${achievement.name}</strong>
                        <div style="font-size: 0.9em; color: #666;">${achievement.description}</div>
                        <div class="achievement-progress">
                            <div class="achievement-progress-bar" style="width: ${Math.min(progressPercent, 100)}%"></div>
                        </div>
                        <div style="font-size: 0.8em; color: #888;">
                            Progress: ${achievement.progress.toFixed(1)}/${achievement.target}
                        </div>
                    </div>
                    <div style="color: var(--success); font-weight: bold;">
                        +${achievement.reward} SAM
                    </div>
                `;
                
                achievementsList.appendChild(achievementElement);
                
                // Track recently unlocked achievements
                if (achievement.unlocked && achievement.progress === achievement.target) {
                    recentUnlocked.push(achievement);
                }
            });
            
            // Show recent achievements (last 3 unlocked)
            recentUnlocked.slice(-3).reverse().forEach(achievement => {
                const recentElement = document.createElement('div');
                recentElement.className = 'achievement-item unlocked';
                recentElement.innerHTML = `
                    <div class="achievement-icon">üèÜ</div>
                    <div class="achievement-info">
                        <strong>${achievement.name}</strong>
                        <div style="font-size: 0.9em; color: #666;">Unlocked!</div>
                    </div>
                `;
                recentAchievements.appendChild(recentElement);
            });
        }

        function updateAchievementProgress(achievementId, progress) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (achievement && !achievement.unlocked) {
                achievement.progress = Math.min(progress, achievement.target);
                
                if (achievement.progress >= achievement.target && !achievement.unlocked) {
                    achievement.unlocked = true;
                    coinsMined += achievement.reward;
                    showNotification(`Achievement unlocked: ${achievement.name}! +${achievement.reward} SAM`);
                    renderAchievements();
                }
            }
        }

        // Quest system
        function renderQuests() {
            const questsList = document.getElementById('questsList');
            questsList.innerHTML = '';
            
            quests.forEach(quest => {
                const questElement = document.createElement('div');
                questElement.className = `quest-item ${quest.completed ? 'completed' : ''}`;
                
                const progressPercent = (quest.progress / quest.target) * 100;
                
                questElement.innerHTML = `
                    <div>
                        <strong>${quest.name}</strong>
                        <div style="font-size: 0.9em; color: #666;">${quest.description}</div>
                        <div style="font-size: 0.8em; color: #888;">
                            Progress: ${quest.progress.toFixed(1)}/${quest.target}
                        </div>
                    </div>
                    <div class="quest-reward">
                        +${quest.reward} SAM
                    </div>
                `;
                
                questsList.appendChild(questElement);
            });
        }

        function updateQuestProgress(questId, progress) {
            const quest = quests.find(q => q.id === questId);
            if (quest && !quest.completed) {
                quest.progress += progress;
                
                if (quest.progress >= quest.target && !quest.completed) {
                    quest.completed = true;
                    coinsMined += quest.reward;
                    showNotification(`Quest completed: ${quest.name}! +${quest.reward} SAM`);
                    renderQuests();
                }
            }
        }

        // Referral system
        function generateReferralCode() {
            return 'REF' + Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        async function updateReferralInfo() {
            try {
                const userDoc = await database.getDocument(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID, userId);
                document.getElementById('referralCode').textContent = userDoc.referralCode;
                document.getElementById('referralCount').textContent = userDoc.referrals ? userDoc.referrals.length : 0;
                document.getElementById('referralEarnings').textContent = userDoc.referralEarnings || 0;
            } catch (error) {
                console.error('Error loading referral info:', error);
            }
        }

        function copyReferralCode() {
            const referralCode = document.getElementById('referralCode').textContent;
            navigator.clipboard.writeText(referralCode).then(() => {
                showNotification('Referral code copied to clipboard!');
            });
        }

        async function handleReferral(referralCode) {
            try {
                // Find referrer and update their data
                const allUsers = await database.listDocuments(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID);
                const referrer = allUsers.documents.find(user => user.referralCode === referralCode);
                
                if (referrer) {
                    const updatedReferrals = [...(referrer.referrals || []), userId];
                    const updatedReferralEarnings = (referrer.referralEarnings || 0) + 10; // Bonus for referrer
                    
                    await database.updateDocument(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID, referrer.$id, {
                        referrals: updatedReferrals,
                        referralEarnings: updatedReferralEarnings
                    });
                    
                    // Give bonus to new user
                    coinsMined += 5;
                    showNotification('Referral bonus applied! +5 SAM');
                }
            } catch (error) {
                console.error('Error handling referral:', error);
            }
        }

        // Leaderboard system
        async function loadLeaderboard() {
            try {
                const allUsers = await database.listDocuments(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID);
                const sortedUsers = allUsers.documents
                    .filter(user => user.coinsMined > 0)
                    .sort((a, b) => b.coinsMined - a.coinsMined)
                    .slice(0, 20);
                
                const leaderboard = document.getElementById('globalLeaderboard');
                leaderboard.innerHTML = '';
                
                sortedUsers.forEach((user, index) => {
                    const leaderboardItem = document.createElement('div');
                    leaderboardItem.className = 'leaderboard-item';
                    
                    leaderboardItem.innerHTML = `
                        <div class="leaderboard-rank">#${index + 1}</div>
                        <div class="leaderboard-name">
                            ${user.username}
                            ${user.$id === userId ? '<span class="badge">You</span>' : ''}
                        </div>
                        <div class="leaderboard-score">${user.coinsMined.toFixed(2)} SAM</div>
                    `;
                    
                    leaderboard.appendChild(leaderboardItem);
                });
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Analytics chart
        function initializeChart() {
            const ctx = document.getElementById('miningChart').getContext('2d');
            
            if (miningChart) {
                miningChart.destroy();
            }
            
            // Generate sample data (in real app, use actual mining session data)
            const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const data = [10, 25, 35, 50, 65, 80];
            
            miningChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Coins Mined',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Withdraw functionality
        withdrawButton.addEventListener('click', async () => {
            if (coinsMined < 1) {
                showNotification('Minimum withdrawal is 1 SupremeAmer coin', true);
                return;
            }

            try {
                // Get current user data
                const userDoc = await database.getDocument(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID, userId);
                
                // Create withdrawal transaction
                const transaction = {
                    type: 'withdrawal',
                    amount: parseFloat(coinsMined.toFixed(6)),
                    bnbAddress: SUPREMEAMER_RECEIVER_BNB,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                };

                // Update achievement
                updateAchievementProgress('first_withdrawal', 1);

                // Update user document
                const updatedTransactions = [...(userDoc.transactions || []), JSON.stringify(transaction)];
                
                await database.updateDocument(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID, userId, {
                    coinsMined: 0,
                    totalWithdrawn: (userDoc.totalWithdrawn || 0) + coinsMined,
                    transactions: updatedTransactions
                });

                // Reset local state
                coinsMined = 0;
                miningTime = 0;
                
                showNotification(`Successfully withdrew ${transaction.amount} SupremeAmer coins to ${SUPREMEAMER_RECEIVER_BNB}`);
                updateUI();
                loadTransactionHistory();
                
            } catch (error) {
                console.error('Error processing withdrawal:', error);
                showNotification('Error processing withdrawal', true);
            }
        });

        // Update UI
        function updateUI() {
            coinsMinedElement.textContent = coinsMined.toFixed(6);
            miningTimeElement.textContent = miningTime.toFixed(2);
            
            // Calculate earnings (assuming 1 SupremeAmer = $0.01 for demo)
            const earnings = coinsMined * 0.01;
            totalEarningsElement.textContent = '$' + earnings.toFixed(4);
            
            // Update mining power display
            document.getElementById('miningPower').textContent = calculateTotalMiningPower().toFixed(1);
            
            // Enable/disable withdraw button
            withdrawButton.disabled = coinsMined < 1;
        }

        // Load transaction history
        async function loadTransactionHistory() {
            try {
                const userDoc = await database.getDocument(APPWRITE_DB_ID, APPWRITE_COLLECTION_ID, userId);
                const transactions = userDoc.transactions || [];
                
                transactionList.innerHTML = '';
                
                if (transactions.length === 0) {
                    transactionList.innerHTML = '<p style="text-align: center; color: #666;">No transactions yet</p>';
                    return;
                }
                
                // Parse and display transactions
                transactions.reverse().forEach(transactionStr => {
                    try {
                        const transaction = JSON.parse(transactionStr);
                        const transactionElement = document.createElement('div');
                        transactionElement.className = 'transaction-item';
                        
                        const date = new Date(transaction.timestamp).toLocaleDateString();
                        const amount = transaction.amount.toFixed(6);
                        
                        transactionElement.innerHTML = `
                            <div>
                                <strong>${transaction.type.toUpperCase()}</strong>
                                <div style="font-size: 0.8em; color: #666;">${date}</div>
                            </div>
                            <div class="transaction-amount">${amount} SAM</div>
                            <div style="font-size: 0.8em; color: #666;">${transaction.status}</div>
                        `;
                        
                        transactionList.appendChild(transactionElement);
                    } catch (e) {
                        console.error('Error parsing transaction:', e);
                    }
                });
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        // Notification system
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = 'notification';
            
            if (isError) {
                notification.classList.add('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Check if user is already logged in
        async function checkExistingSession() {
            try {
                currentUser = await account.get();
                userId = currentUser.$id;
                await initializeUser();
                loginSection.classList.add('hidden');
                miningInterface.classList.remove('hidden');
            } catch (error) {
                // No existing session, stay on login page
                console.log('No existing session');
            }
        }

        // Initialize the app
        checkExistingSession();
    </script>
</body>
</html>